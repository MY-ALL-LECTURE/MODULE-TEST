use lmsdb;
-- 1.다음과 같은 결과물이 나오는 SQL 쿼리문을 완성하세요.
select no, lec_duration, lec_time, t_name, lec_name, T_C_L.class_no
from tbl_current_lecture T_C_L
inner join tbl_classroom T_C
on T_C_L.class_no = T_C.class_no
inner join tbl_lecture T_L
on T_C_L.lec_code = T_L.lec_code
inner join tbl_teacher T_T
on T_C_L.t_id = T_T.t_id;

-- 2. 위 join 결과를 완성하는 view table을 만드세요.
select no, lec_duration, lec_time, t_name, lec_name, T_C_L.class_no
from tbl_current_lecture T_C_L
inner join tbl_classroom T_C
on T_C_L.class_no = T_C.class_no
inner join tbl_lecture T_L
on T_C_L.lec_code = T_L.lec_code
inner join tbl_teacher T_T
on T_C_L.t_id = T_T.t_id;

select * from view_current_lecture;

-- 3. 다음에 만족하는 피벗 SQL문을 완성하세요.
select lec_name, 
	count(case when lec_time = '09:00 - 12:00' then 1 end) as '09:00 - 12:00',
	count(case when lec_time = '13:00 - 15:00' then 1 end) as '13:00 - 15:00',
	count(case when lec_time = '15:00 - 17:00' then 1 end) as '15:00 - 17:00'
from  tbl_lecture
inner join tbl_current_lecture
on tbl_lecture.lec_code = tbl_current_lecture.lec_code
group by lec_name with rollup;

-- 4. tbl_registration에 에러가 발생하면 다음과 같이 tbl_errlog에 저장될 수 있도록 하는 프로시저를 만드세요.
-- drop procedure proc_insert_tbl_registration;
delimiter $$
create procedure proc_insert_tbl_registration(
in sid varchar(45), in lcode int, lduration varchar(100))
begin
	DECLARE error_code VARCHAR(5);
    DECLARE error_message VARCHAR(255);
	-- PK 중복 예외 처리
    declare continue handler for 1062 
    begin
		show errors;
		get DIAGNOSTICS CONDITION 1
			error_code = MYSQL_ERRNO,
            error_message = MESSAGE_TEXT;
		-- select error_code,error_message;
        insert into tbl_errlog values(no, error_code, now(), error_message);
    end;
    
    insert into tbl_registration values(sid, lcode, lduration);
    select * from tbl_registration;
end $$
delimiter ;

call proc_insert_tbl_registration('20190001', 1001, '2023-05-22 - 2023-06-21');
call proc_insert_tbl_registration('20190001', 1001, '2023-05-22 - 2023-06-21');
call proc_insert_tbl_registration('20190001', 7001, '2023-05-22 - 2023-06-21');
call proc_insert_tbl_registration('70190001', 1001, '2023-05-22 - 2023-06-21');
select * from tbl_registration;
select * from tbl_student;
select * from tbl_errlog;

-- 5. tbl_student update시 tbl_student_bak에 이전데이터 삽입 트리거를 만드세요.
-- drop trigger tbl_student_update_trg;
delimiter $$
create trigger tbl_student_update_trg
after update
on tbl_student
for each row
begin
	insert into tbl_student_bak values(
    old.s_id, old.s_name, old.s_phone, now(), null
    );
end $$
delimiter ;

-- [확인]
-- delete from tbl_student where s_id = '20191234';
insert into tbl_student values('20191234','나나나','010-1234-1234');
update tbl_student set s_name ='우우우' where s_id = '20191234';
select * from tbl_student;
select * from tbl_student_bak;

-- 6. tbl_teacher update시 tbl_teacher_bak에 이전데이터 삽입 트리거를 만드세요.
-- drop trigger tbl_teacher_update_trg;
delimiter $$
create trigger tbl_teacher_update_trg
after update
on tbl_teacher
for each row
begin
	insert into tbl_teacher_bak values(
    old.t_id, old.t_name, old.t_phone, old.t_addr, now(), null 
    );
end $$
delimiter ;

show triggers;
-- [확인]
-- delete from tbl_teacher where t_id = 7;
insert into tbl_teacher values(7,'아무개','010-222-333','대구광역시 달서구');
update tbl_teacher set t_name  = '아무무' where t_id = 7;
update tbl_teacher set t_phone = '010-777-7777' where t_id = 7;
select * from tbl_teacher;
select * from tbl_teacher_bak;

-- 7. tbl_student delete시 tbl_student_bak에 이전데이터 삽입 트리거를 만드세요.
-- drop trigger tbl_student_delete_trg
delimiter $$
create trigger tbl_student_delete_trg
after delete
on tbl_student
for each row
begin
    insert into tbl_student_bak values(
    old.s_id, old.s_name, old.s_phone, null, now()
    );
end $$
delimiter ;

-- [확인]
delete from tbl_student where s_id = '20191234';
select * from tbl_student_bak;

-- 8. tbl_teacher delete시 tbl_teacher_bak에 이전데이터 삽입 트리거를 만드세요.
-- drop trigger tbl_teacher_delete_trg;
delimiter $$
create trigger tbl_teacher_delete_trg
after delete
on tbl_teacher
for each row
begin
    insert into tbl_teacher_bak values(
    old.t_id, old.t_name, old.t_phone, old.t_addr, null, now() 
    );
end $$
delimiter ;

-- [확인]
delete from tbl_teacher where t_id = 7;
select * from tbl_teacher;
select * from tbl_teacher_bak;
